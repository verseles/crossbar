# Crossbar Development Environment
# Docker Compose configuration for containerized development
#
# Usage:
#   docker compose up -d flutter-linux    # Start Linux dev environment
#   docker compose run flutter-linux bash # Interactive shell
#   docker compose run flutter-test       # Run tests
#   docker compose run flutter-build      # Build Linux release

services:
  # Linux Development Environment
  flutter-linux:
    build:
      context: .
      dockerfile: docker/Dockerfile.linux
    image: crossbar-linux:latest
    container_name: crossbar-linux
    volumes:
      - .:/app
      - flutter-linux-cache:/opt/flutter/.pub-cache
      - flutter-linux-gradle:/home/developer/.gradle
    working_dir: /app
    stdin_open: true
    tty: true
    environment:
      - HOME=/home/developer
      - DISPLAY=${DISPLAY:-:0}
    command: bash

  # Android Development Environment
  flutter-android:
    build:
      context: .
      dockerfile: docker/Dockerfile.android
    image: crossbar-android:latest
    container_name: crossbar-android
    volumes:
      - .:/app
      - flutter-android-cache:/opt/flutter/.pub-cache
      - flutter-android-gradle:/home/developer/.gradle
    working_dir: /app
    stdin_open: true
    tty: true
    environment:
      - HOME=/home/developer
    command: bash

  # Test Runner
  flutter-test:
    build:
      context: .
      dockerfile: docker/Dockerfile.linux
    image: crossbar-linux:latest
    container_name: crossbar-test
    volumes:
      - .:/app:ro
      - flutter-test-cache:/opt/flutter/.pub-cache
    working_dir: /app
    environment:
      - HOME=/home/developer
    command: >
      sh -c "
        flutter pub get &&
        flutter analyze --no-fatal-infos &&
        flutter test --coverage &&
        echo 'All tests passed!'
      "

  # Linux Build
  flutter-build:
    build:
      context: .
      dockerfile: docker/Dockerfile.linux
    image: crossbar-linux:latest
    container_name: crossbar-build
    volumes:
      - .:/app
      - flutter-build-cache:/opt/flutter/.pub-cache
      - ./build:/app/build
    working_dir: /app
    environment:
      - HOME=/home/developer
    command: >
      sh -c "
        flutter pub get &&
        flutter build linux --release &&
        echo 'Linux build complete!'
      "

  # Android APK Build
  flutter-apk:
    build:
      context: .
      dockerfile: docker/Dockerfile.android
    image: crossbar-android:latest
    container_name: crossbar-apk
    volumes:
      - .:/app
      - flutter-apk-cache:/opt/flutter/.pub-cache
      - flutter-apk-gradle:/home/developer/.gradle
      - ./build:/app/build
    working_dir: /app
    environment:
      - HOME=/home/developer
    command: >
      sh -c "
        flutter pub get &&
        flutter build apk --release &&
        echo 'Android APK build complete!'
      "

volumes:
  flutter-linux-cache:
  flutter-linux-gradle:
  flutter-android-cache:
  flutter-android-gradle:
  flutter-test-cache:
  flutter-build-cache:
  flutter-apk-cache:
  flutter-apk-gradle:
